<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Found-It</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; text-align: center; margin: 0; }
        .container { width: 100%; max-width: 450px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: left; }
        input, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #4285F4; color: white; border: none; cursor: pointer; font-weight: bold; font-size: 16px; }
        .loc-btn { background: #34A853; margin-top: -10px; font-size: 13px; }
        label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 5px; color: #444; }
        #status { margin-bottom: 15px; font-weight: bold; font-size: 14px; text-align: center; color: #555; }
        .feed-item { background: white; padding: 15px; margin-top: 15px; border-radius: 10px; border-left: 5px solid #34A853; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .feed-img { width: 100%; border-radius: 8px; margin: 10px 0; max-height: 300px; object-fit: cover; display: block; }
        .map-link { background: #fbbc05; color: black; padding: 8px 12px; border-radius: 5px; text-decoration: none; font-size: 13px; font-weight: bold; display: inline-block; margin-top: 10px; }
        .delete-btn { background: #ea4335; color: white; padding: 8px; border-radius: 5px; border: none; font-size: 12px; cursor: pointer; margin-top: 10px; width: auto; }
    </style>
</head>
<body>

<div class="container">
    <h1>üìç Campus Found-It</h1>
    
    <div class="card">
        <label>1. Item Photo (Optional)</label>
        <input type="file" id="imageInput" accept="image/*">
        
        <label>2. Item Description</label>
        <input type="text" id="manualDesc" placeholder="e.g. Blue Water Bottle">
        
        <label>3. Where to collect? (Required if no contact)</label>
        <input type="text" id="manualLoc" placeholder="e.g. Canteen Counter">
        <button class="loc-btn" id="geoBtn">üìç Pin My Current GPS Location</button>
        <input type="hidden" id="lat"><input type="hidden" id="lng">
        
        <label>4. Your Contact (Required if no location)</label>
        <input type="text" id="finderContact" placeholder="Phone Number / Email">
        
        <label>5. Found By (Name)</label>
        <input type="text" id="finderName" placeholder="Your Name">
        
        <div id="status">Ready</div>
        <button id="mainBtn">Post to Campus Feed</button>
    </div>

    <div id="itemList">
        <h3 style="margin-top:30px;">Live Campus Feed</h3>
    </div>
</div>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCK1Dv_jFaLuXApiCXTA45D0oF6FGFB2SQ",
        authDomain: "campusfoundit.firebaseapp.com",
        projectId: "campusfoundit",
        storageBucket: "campusfoundit.firebasestorage.app",
        messagingSenderId: "151417592098",
        appId: "1:151417592098:web:1cb43b26bdb596236e2d7b"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. GPS PINNING
    document.getElementById('geoBtn').addEventListener('click', () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('lat').value = pos.coords.latitude;
                document.getElementById('lng').value = pos.coords.longitude;
                const status = document.getElementById('status');
                status.innerText = "üìç GPS Captured Successfully!";
                status.style.color = "green";
            }, err => {
                alert("Could not get location. Please enable GPS.");
            });
        }
    });

    // 3. MAIN POST FUNCTION
    async function postItem() {
        const fileInput = document.getElementById('imageInput');
        const descInput = document.getElementById('manualDesc');
        const locInput = document.getElementById('manualLoc');
        const latVal = document.getElementById('lat').value;
        const lngVal = document.getElementById('lng').value;
        const contactInput = document.getElementById('finderContact');
        const nameInput = document.getElementById('finderName');
        const status = document.getElementById('status');
        const btn = document.getElementById('mainBtn');

        // VALIDATION LOGIC
        const hasIdentity = descInput.value.trim() || fileInput.files[0];
        const hasLocation = locInput.value.trim() || latVal;
        const hasContact = contactInput.value.trim();

        if (!hasIdentity) {
            alert("Please provide at least a photo or an item name!");
            return;
        }

        if (!hasLocation && !hasContact) {
            alert("Mandatory: You must provide either a location OR contact details so the owner can recover the item.");
            status.innerText = "‚ùå Missing Location/Contact";
            status.style.color = "red";
            return;
        }

        try {
            btn.disabled = true;
            status.innerText = "‚è≥ Posting to feed...";
            status.style.color = "#555";

            let photoData = null;
            if (fileInput.files[0]) {
                photoData = await toBase64(fileInput.files[0]);
            }

            await db.collection("items").add({
                description: descInput.value || "Found Item",
                locationName: locInput.value || (latVal ? "GPS Pinned Location" : "Not Provided"),
                lat: latVal || null,
                lng: lngVal || null,
                contact: contactInput.value || "Not Provided",
                finder: nameInput.value || "Anonymous",
                photo: photoData,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            status.innerText = "‚úÖ Successfully Posted!";
            status.style.color = "green";

            // RESET FORM
            [descInput, locInput, contactInput, nameInput, fileInput].forEach(i => i.value = "");
            document.getElementById('lat').value = ""; document.getElementById('lng').value = "";
        } catch (e) {
            console.error(e);
            status.innerText = "‚ùå Error. Check your connection.";
            status.style.color = "red";
        } finally {
            btn.disabled = false;
        }
    }

    // 4. DELETE FUNCTION
    window.removeItem = async function(id) {
        if (confirm("Mark this as found and remove it?")) {
            await db.collection("items").doc(id).delete();
        }
    };

    // HELPERS
    function toBase64(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
        });
    }

    document.getElementById('mainBtn').addEventListener('click', postItem);

    // 5. LIVE FEED LISTENER
    db.collection("items").orderBy("createdAt", "desc").onSnapshot(snap => {
        const list = document.getElementById('itemList');
        list.innerHTML = "<h3>Live Campus Feed</h3>";
        if (snap.empty) list.innerHTML += "<p>No items posted yet.</p>";
        
        snap.forEach(doc => {
            const item = doc.data();
            const mapUrl = (item.lat && item.lng) 
                ? `https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}`
                : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.locationName)}`;

            list.innerHTML += `
                <div class="feed-item">
                    <strong>${item.description}</strong><br>
                    <small>By: ${item.finder}</small>
                    ${item.photo ? `<img src="${item.photo}" class="feed-img">` : ''}
                    <div style="margin-top:10px;">
                        <a href="${mapUrl}" target="_blank" class="map-link">üìç View Recovery Spot</a>
                    </div>
                    <div style="font-size:13px; color:#444; margin-top:10px; border-top:1px solid #eee; padding-top:8px;">
                        <b>Location:</b> ${item.locationName}<br>
                        <b>Contact:</b> ${item.contact}
                    </div>
                    <button class="delete-btn" onclick="removeItem('${doc.id}')">Returned to Owner</button>
                </div>`;
        });
    });
</script>

</body>
</html>
