<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Found-It</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; text-align: center; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); max-width: 400px; margin: 0 auto; }
        input, button { width: 100%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #4285F4; color: white; border: none; cursor: pointer; font-weight: bold; }
        #status { margin-top: 10px; font-weight: bold; color: #555; font-size: 14px; }
        .feed-item { background: white; padding: 15px; margin-top: 10px; border-radius: 8px; border-left: 5px solid #34A853; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        .location-tag { color: #d93025; font-size: 0.85em; font-weight: bold; }
        .contact-info { font-size: 0.85em; color: #666; margin-top: 5px; font-style: italic; }
        .delete-btn { background: #ea4335; color: white; padding: 5px 10px; border-radius: 5px; border: none; font-size: 11px; cursor: pointer; margin-top: 10px; width: auto; }
    </style>
</head>
<body>

    <h1>üìç Campus Found-It</h1>
    <div class="card">
        <strong>1. Select Photo (Optional)</strong>
        <input type="file" id="imageInput" accept="image/*">
        
        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
        
        <strong>2. Item Details</strong>
        <input type="text" id="manualDesc" placeholder="Item (e.g. Blue Bottle)">
        <input type="text" id="manualLoc" placeholder="Found at (e.g. Library)">
        
        <strong>3. Your Info (Optional)</strong>
        <input type="text" id="finderName" placeholder="Your Name">
        <input type="text" id="finderContact" placeholder="Phone or Instagram">
        
        <button id="mainBtn">Post to Campus Feed</button>
        <p id="status">Ready</p>
    </div>

    <div id="itemList" style="max-width:400px; margin: 20px auto;">
        <h3>Live Feed</h3>
    </div>

<script>
    // 1. FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCK1Dv_jFaLuXApiCXTA45D0oF6FGFB2SQ",
        authDomain: "campusfoundit.firebaseapp.com",
        projectId: "campusfoundit",
        storageBucket: "campusfoundit.firebasestorage.app",
        messagingSenderId: "151417592098",
        appId: "1:151417592098:web:1cb43b26bdb596236e2d7b"
    };
    const GEMINI_KEY = "AIzaSyCvkL7vPRn_ia3OW5uFcCmxG9ypsSMkD6w";

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // 2. POST FUNCTION
    async function postItem() {
        const fileInput = document.getElementById('imageInput');
        const descInput = document.getElementById('manualDesc');
        const locInput = document.getElementById('manualLoc');
        const nameInput = document.getElementById('finderName');
        const contactInput = document.getElementById('finderContact');
        const status = document.getElementById('status');
        const btn = document.getElementById('mainBtn');

        let description = descInput.value;
        const location = locInput.value || "Unknown Location";
        const finder = nameInput.value || "Anonymous";
        const contact = contactInput.value || "Contact at Found Location";

        if (!description && !fileInput.files[0]) {
            alert("Please provide a photo or a description!");
            return;
        }

        try {
            btn.disabled = true;
            status.innerText = "Processing...";

            if (fileInput.files[0]) {
                status.innerText = "‚è≥ AI is identifying...";
                const base64 = await toBase64(fileInput.files[0]);
                const cleanBase64 = base64.split(',')[1];
                
                try {
                    const url = `https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`;
                    const resp = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "Describe this object in 3 words." }, { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }] }]
                        })
                    });
                    const data = await resp.json();
                    if (resp.ok && !description) {
                        description = data.candidates[0].content.parts[0].text;
                    }
                } catch (aiErr) { console.log("AI Offline, using manual data."); }
            }

            if (!description) description = "Unidentified Item";

            await db.collection("items").add({
                description: description,
                location: location,
                finderName: finder,
                contactInfo: contact,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            status.innerText = "‚úÖ Successfully Posted!";
            // Reset fields
            [descInput, locInput, nameInput, contactInput, fileInput].forEach(i => i.value = "");
        } catch (e) {
            alert("Error: " + e.message);
            status.innerText = "‚ùå Error";
        } finally { btn.disabled = false; }
    }

    // 3. REMOVE FUNCTION
    window.removeItem = async function(id) {
        if (confirm("Mark this item as returned and remove it?")) {
            try {
                await db.collection("items").doc(id).delete();
            } catch (e) { alert("Error deleting: " + e.message); }
        }
    }

    // HELPER
    function toBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    }

    // BIND BUTTON
    document.getElementById('mainBtn').addEventListener('click', postItem);

    // 4. LIVE FEED
    db.collection("items").orderBy("createdAt", "desc").onSnapshot(snap => {
        const list = document.getElementById('itemList');
        list.innerHTML = "<h3>Live Feed</h3>";
        snap.forEach(doc => {
            const item = doc.data();
            list.innerHTML += `
                <div class="feed-item">
                    <strong>${item.description}</strong><br>
                    <span class="location-tag">üìç ${item.location}</span>
                    <div class="contact-info">Found by: ${item.finderName} | Contact: ${item.contactInfo}</div>
                    <button class="delete-btn" onclick="removeItem('${doc.id}')">Returned to Owner</button>
                </div>`;
        });
    });
</script>
</body>
</html>
