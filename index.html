<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Found-It</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; padding: 20px; text-align: center; margin: 0; }
        .container { width: 100%; max-width: 450px; margin: 0 auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: left; }
        input, button { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        button { background: #4285F4; color: white; border: none; cursor: pointer; font-weight: bold; }
        .loc-btn { background: #34A853; font-size: 13px; margin-top: -5px; }
        label { display: block; font-weight: bold; font-size: 13px; margin-bottom: 5px; color: #444; }
        #status { margin-bottom: 10px; font-weight: bold; color: #555; text-align: center; min-height: 20px; font-size: 13px; }
        #manualSection { display: none; border-top: 2px dashed #eee; padding-top: 15px; margin-top: 15px; }
        .feed-item { background: white; padding: 15px; margin-top: 15px; border-radius: 10px; border-left: 5px solid #34A853; text-align: left; }
        .feed-img { width: 100%; border-radius: 8px; margin: 10px 0; max-height: 250px; object-fit: cover; }
        .map-link { background: #fbbc05; color: black; padding: 8px 12px; border-radius: 5px; text-decoration: none; font-size: 12px; font-weight: bold; display: inline-block; margin-top: 5px; }
        .return-btn { background: #ea4335; color: white; padding: 8px; border-radius: 5px; border: none; font-size: 11px; cursor: pointer; margin-top: 10px; }

        .footer { margin-top: 40px; padding-bottom: 30px; }
        .footer h4 { color: #555; font-size: 16px; margin-bottom: 20px; border-bottom: 2px solid #ddd; display: inline-block; padding-bottom: 5px; }
        .team-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
        .dev-member { text-align: center; }
        .dev-pfp { width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 3px solid #4285F4; margin-bottom: 8px; }
        .dev-name { font-size: 12px; font-weight: bold; color: #333; line-height: 1.2; }

        body {
            background-image: linear-gradient(rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.7)), 
                      url('bg.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>üìç Campus Found-It</h1>
    <div class="card">
        <div id="uploadStep">
            <label>1. Upload Photo</label>
            <input type="file" id="imageInput" accept="image/*">
            <button id="aiBtn">Identify with AI</button>
            <p style="text-align:center; font-size:12px; color:#888;">‚Äî OR ‚Äî</p>
            <button onclick="document.getElementById('manualSection').style.display='block'" style="background:#666; font-size:12px;">Post Without Photo</button>
        </div>

        <div id="manualSection">
            <label>Item Name</label>
            <input type="text" id="manualDesc" placeholder="e.g. Desk Lamp">
            <label>Where to collect?</label>
            <input type="text" id="manualLoc" placeholder="e.g. Library Front Desk">
            <button class="loc-btn" id="geoBtn">üìç Capture My Current Location (GPS)</button>
            <input type="hidden" id="lat"><input type="hidden" id="lng">
            <label>Your Contact Details</label>
            <input type="text" id="finderContact" placeholder="Phone or Email">
            <label>Found By</label>
            <input type="text" id="finderName" placeholder="Your Name">
            <button id="mainBtn" style="background:#34A853;">Post to Feed</button>
        </div>
        <p id="status">Ready</p>
    </div>
    <div id="itemList"></div>

    <div class="footer">
        <h4>Developed By</h4>
        
            <div class="dev-member">
                <img src="pfp1.png" class="dev-pfp" alt="Devansh">
                <div class="dev-name">Devansh Katariya</div>
            </div>
            
        </div>
    </div>

</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCK1Dv_jFaLuXApiCXTA45D0oF6FGFB2SQ",
        authDomain: "campusfoundit.firebaseapp.com",
        projectId: "campusfoundit",
        storageBucket: "campusfoundit.firebasestorage.app",
        appId: "1:151417592098:web:1cb43b26bdb596236e2d7b"
    };
    const GEMINI_KEY = "AIzaSyCla-SJs0BZDj_nW5m6-HFRf1xVYEoeRqI";
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // AI IDENTIFICATION WITH AUTO-RETRY
    document.getElementById('aiBtn').addEventListener('click', async () => {
        const file = document.getElementById('imageInput').files[0];
        const status = document.getElementById('status');
        if (!file) return alert("Select a photo!");

        status.innerText = "‚è≥ AI warming up...";
        document.getElementById('manualSection').style.display = "block"; 

        const cleanBase = (await resizeImage(file, 300)).split(',')[1];
        
        for (let i = 1; i <= 4; i++) {
            status.innerText = `‚è≥ AI Attempt ${i} (Wait for warm-up)...`;
            try {
                const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "What is this? Just the name." }, { inline_data: { mime_type: "image/jpeg", data: cleanBase } }] }],
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                        ]
                    })
                });

                const data = await resp.json();
                if (resp.ok && data.candidates) {
                    document.getElementById('manualDesc').value = data.candidates[0].content.parts[0].text;
                    status.innerText = "‚úÖ AI Identified!";
                    status.style.color = "green";
                    return; 
                }
            } catch (e) { console.log("Retry needed..."); }
            await new Promise(r => setTimeout(r, 2000));
        }
        status.innerText = "‚ö†Ô∏è AI Busy. Please type manually.";
    });

    function resizeImage(file, maxWidth) {
        return new Promise((r) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    r(canvas.toDataURL('image/jpeg', 0.5));
                };
            };
        });
    }

    // GPS CAPTURE
    document.getElementById('geoBtn').addEventListener('click', () => {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('lat').value = pos.coords.latitude;
                document.getElementById('lng').value = pos.coords.longitude;
                document.getElementById('status').innerText = "üìç Capture My Current Location successful!";
                document.getElementById('status').style.color = "blue";
            });
        }
    });

    // POST LOGIC
    document.getElementById('mainBtn').addEventListener('click', async () => {
        const desc = document.getElementById('manualDesc').value;
        const loc = document.getElementById('manualLoc').value;
        const lat = document.getElementById('lat').value;
        const lng = document.getElementById('lng').value;
        const contact = document.getElementById('finderContact').value;
        const file = document.getElementById('imageInput').files[0];

        if (!desc && !file) return alert("Info required!");

        try {
            document.getElementById('status').innerText = "‚è≥ Posting...";
            let photo = file ? await resizeImage(file, 800) : null;
            await db.collection("items").add({
                description: desc || "Found Item",
                locationName: loc || (lat ? "GPS Pin" : "Campus"),
                lat: lat || null,
                lng: lng || null,
                contact: contact || "Contact Finder",
                finder: document.getElementById('finderName').value || "Anonymous",
                photo: photo,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('status').innerText = "‚úÖ Posted successfully!";
            document.getElementById('status').style.color = "green";
            setTimeout(() => { location.reload(); }, 2000);
        } catch (e) { alert("Error: " + e.message); }
    });

    // DELETE LOGIC
    window.removeItem = async function(id) {
        if (confirm("Mark this item as returned to owner?")) await db.collection("items").doc(id).delete();
    };

    // FEED LOGIC
    db.collection("items").orderBy("createdAt", "desc").onSnapshot(snap => {
        const list = document.getElementById('itemList');
        list.innerHTML = "<h3>Live Feed</h3>";
        snap.forEach(doc => {
            const item = doc.data();
            
            // FIXED MAP LINK: Uses standard Google Maps query format
            let mapLink = (item.lat && item.lng) ? `<div><a href="https://www.google.com/maps/search/?api=1&query=${item.lat},${item.lng}" target="_blank" class="map-link">üìç View Spot on Map</a></div>` : "";
            
            list.innerHTML += `<div class="feed-item"><strong>${item.description}</strong><br>${item.photo ? `<img src="${item.photo}" class="feed-img">` : ''}${mapLink}<div style="font-size:12px; margin-top:8px;">Loc: ${item.locationName}<br>Contact: ${item.contact}</div><button class="return-btn" onclick="removeItem('${doc.id}')">Returned to Owner</button></div>`;
        });
    });
</script>
</body>
</html>
